import { Pool } from 'pg';
import yahooFinanceService from './yahooFinanceService.js';
import { scrapeRealPrice } from './yahooScraper.js';

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

class AiTipGenerator {
  
  // NEW V2 ENGINE METHOD
  async processDeepBrainRecommendations(analysis: any) {
    console.log('   ðŸ’° Processing Deep Brain Recommendations...');
    
    // 1. Clear old active tips to keep the dashboard fresh
    await pool.query("DELETE FROM ai_stock_tips WHERE status = 'active'");

    const picks: any[] = [];

    // 2. Flatten and Tag Defensive Picks
    if (analysis.defensive_sector?.picks) {
        analysis.defensive_sector.picks.forEach((p: any) => {
            picks.push({ ...p, tier: 'blue_chip', category: 'Safe & Steady' });
        });
    }

    // 3. Flatten and Tag Growth Picks
    if (analysis.growth_sectors) {
        analysis.growth_sectors.forEach((sector: any) => {
            if (sector.picks) {
                sector.picks.forEach((p: any) => {
                    picks.push({ ...p, tier: 'explosive_growth', category: 'High Growth' });
                });
            }
        });
    }

    // 4. Flatten and Tag Crypto Picks
    if (analysis.crypto_unicorns) {
        analysis.crypto_unicorns.forEach((p: any) => {
            picks.push({ ...p, tier: 'crypto_alpha', category: 'Crypto' });
        });
    }

    console.log(`   ðŸ” Validating prices for ${picks.length} candidates...`);

    // 5. Validate Prices & Save
    for (const pick of picks) {
        await this.saveTip(pick);
    }
  }

  // LEGACY COMPATIBILITY METHOD
  // This is required because older routes (aiTips.ts) still call it.
  // In V2, tips are generated via the Analysis Engine, not directly.
  // This fallback returns the current active tips from the DB to satisfy the type checker.
  async generateComprehensiveTips() {
    console.log("   âš ï¸ Legacy Tip Generation Route Called - Returning Active Tips");
    const res = await pool.query("SELECT * FROM ai_stock_tips WHERE status = 'active'");
    return res.rows;
  }

  private async saveTip(pick: any) {
      try {
        let ticker = pick.ticker.toUpperCase();
        
        // Standardization for Crypto Tickers on Yahoo
        if (pick.tier === 'crypto_alpha' && !ticker.includes('-')) {
            if (!ticker.endsWith('USD')) ticker = `${ticker}-USD`;
        }

        // 1. Attempt Real Price Fetch
        let price = await this.getRealPrice(ticker);
        
        // 2. Fallback scraper
        if (price === 0) {
             price = await scrapeRealPrice(ticker) || 0;
        }

        // 3. Calculate Targets based on Real Price
        const finalPrice = price > 0 ? price : 0;
        const entry = finalPrice > 0 ? finalPrice : (pick.entry || 100); // Fallback only if API fails completely
        
        // If API price is 0, we mark as 'pending_price' so it doesn't show invalid data
        const status = finalPrice > 0 ? 'active' : 'pending_price';
        
        const targetPct = pick.target_gain_pct || 15;
        const stopPct = pick.stop_loss_pct || 8;
        
        const target = entry * (1 + (targetPct / 100));
        const stop = entry * (1 - (stopPct / 100));
        
        await pool.query(`
          INSERT INTO ai_stock_tips
          (ticker, company_name, action, tier, entry_price, current_price, target_price, stop_loss,
           expected_gain_percent, risk_score, confidence, timeframe,
           catalysts, reasoning, exit_strategy, status, created_at)
          VALUES ($1, $2, $3, $4, $5, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, NOW())
        `, [
            ticker,
            pick.category, // Using category as company name placeholder if real name fetch is too slow
            pick.action || 'BUY',
            pick.tier,
            entry, 
            target, 
            stop, 
            targetPct,
            pick.tier === 'blue_chip' ? 3 : (pick.tier === 'explosive_growth' ? 7 : 9), // Risk Score
            85, // Base confidence for AI picks
            'Medium Term', 
            '[]', // Catalysts JSON
            pick.reason, 
            `Target: $${target.toFixed(2)}`, 
            status
        ]);
        
        if (price > 0) console.log(`      + ${pick.ticker}: $${price.toFixed(2)}`);
        else console.log(`      + ${pick.ticker}: Saved (Price Pending)`);
        
    } catch (e: any) {
        console.error(`      x Error saving ${pick.ticker}: ${e.message}`);
    }
  }

  private async getRealPrice(ticker: string): Promise<number> {
    try {
        const yPrice = await yahooFinanceService.getPrice(ticker);
        if (yPrice) return yPrice;
        return 0;
    } catch (e) { return 0; }
  }
}

export default new AiTipGenerator();
