import pool from '../db/index.js';
import Anthropic from '@anthropic-ai/sdk';

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY || process.env.CLAUDE_API_KEY
});

class ResearchAgentService {

  async expandKnowledgeBase() {
    console.log('üïµÔ∏è Research Agent: Scanning for Market Dynamics & Patterns...');

    try {
      // 1. Clean ancient history (keep the database modern)
      await pool.query("DELETE FROM historical_events WHERE event_date < '1970-01-01'");
      
      // 2. Get recent themes
      const newsRes = await pool.query(`
        SELECT title FROM raw_intelligence
        WHERE category IN ('news', 'political', 'market', 'insider')
        AND created_at > NOW() - INTERVAL '12 hours'
        ORDER BY created_at DESC LIMIT 40
      `);

      if (newsRes.rows.length === 0) return { expanded: false, message: "No fresh news." };
      const headlines = newsRes.rows.map(r => r.title).join("\n");

      // 3. Ask AI for BROAD parallels (Good & Bad)
      const prompt = `
        You are a Senior Market Strategist.
        
        HEADLINES:
        ${headlines.substring(0, 3000)}

        TASK:
        Identify the dominant "Market Dynamic" happening right now.
        Is it:
        - A Corporate Disruption? (Like Yahoo vs Google)
        - A Political Shift? (Like a new Cabinet or Tax Policy)
        - A Sector Rotation? (Like 2022 Tech -> Energy)
        - A New Technology Boom? (Like the Internet in 1999)
        - Or a Crisis? (Like 2008)

        Find 2 HISTORICAL PARALLELS from 1980-2024 that match this dynamic.
        
        Output JSON only:
        {
          "archetype": "Name of the dynamic (e.g. 'AI Infrastructure Boom')",
          "new_events": [
            {
              "event": "Name of Past Event (Year)",
              "type": "Category (Disruption/Policy/Merger/Boom)",
              "description": "What happened to the companies/sectors involved?",
              "market_impact": 15.0,
              "affected_sectors": ["Sector 1", "Sector 2"],
              "recovery_pattern": "Did the incumbent die? Did the market rally? Be specific.",
              "keywords": ["tag1", "tag2"]
            }
          ]
        }
      `;

      const message = await anthropic.messages.create({
        model: 'claude-3-haiku-20240307',
        max_tokens: 1500,
        messages: [{ role: 'user', content: prompt }]
      });

      const text = message.content[0].type === 'text' ? message.content[0].text : '{}';
      const cleanJson = text.replace(/\n?/g, '').trim();
      const data = JSON.parse(cleanJson);

      // 4. Insert
      let addedCount = 0;
      if (data.new_events && Array.isArray(data.new_events)) {
        for (const evt of data.new_events) {
            const check = await pool.query("SELECT id FROM historical_events WHERE event = $1", [evt.event]);
            if (check.rows.length === 0) {
                await pool.query(`
                  INSERT INTO historical_events
                  (event, event_date, event_type, description, market_impact, duration_days, affected_sectors, recovery_pattern, keywords, collected_at)
                  VALUES ($1, NOW(), $2, $3, $4, 30, $5, $6, $7, NOW())
                `, [
                  evt.event, evt.type, evt.description, evt.market_impact,
                  JSON.stringify(evt.affected_sectors), evt.recovery_pattern, evt.keywords
                ]);
                console.log(`   ‚ú® Learned History: ${evt.event}`);
                addedCount++;
            }
        }
      }

      return { expanded: true, added: addedCount, archetype: data.archetype };

    } catch (error) {
      console.error('Research Agent Error:', error);
      return { expanded: false, error };
    }
  }
}

export default new ResearchAgentService();
